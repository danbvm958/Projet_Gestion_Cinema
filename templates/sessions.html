<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√©ances - Cin√©ma CY Tech</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="{{ url_for('accueil') }}" class="navbar-brand">üé¨ Cin√©ma CY Tech</a>
            <ul class="nav-links">
                <li><a href="{{ url_for('accueil') }}">Accueil</a></li>
                <li><a href="/my-bookings">Mes R√©servations</a></li>
                {% if session.role == 'admin' %}
                    <li><a href="{{ url_for('ajout_film') }}">G√©rer Films</a></li>
                    <li><a href="/admin/sessions">G√©rer S√©ances</a></li>
                {% endif %}
                <li><a href="#" id="logoutLink">D√©connexion</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="hero">
            <h1>üéûÔ∏è Toutes les S√©ances</h1>
            <p>Consultez notre programmation compl√®te</p>
        </div>

        <div id="seancesList">
            <div class="spinner" id="loadingSpinner"></div>
        </div>
    </div>
    <footer class="footer">
        <p>&copy; 2025 Cin√©ma CY Tech</p>
    </footer>

    <div id="reservationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--cinema-card); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <h2 style="color: var(--cinema-accent); margin-bottom: 1rem; font-size: 1.5rem;">üéüÔ∏è R√©server vos places</h2>
            <div id="modalContent" style="margin-bottom: 1.5rem;"></div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--cinema-text); font-weight: 500;">Nombre de places :</label>
                <div id="seatsButtons" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            </div>
            <div id="modalMessage" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;"></div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeModal()" class="btn" style="background: #666;">Annuler</button>
                <button id="confirmBtn" onclick="confirmReservation()" class="btn btn-primary">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        const seancesList = document.getElementById('seancesList');
        const loadingSpinner = document.getElementById('loadingSpinner');

        loadSeances();

        // Charge toutes les s√©ances depuis l'API et les affiche group√©es par date
        async function loadSeances() {
            try {
                loadingSpinner.style.display = 'block';
                const response = await fetch('/api/seances');
                const seances = await response.json();
                
                loadingSpinner.style.display = 'none';

                if (seances.length === 0) {
                    seancesList.innerHTML = '<p class="text-center text-light" style="padding: 3rem; font-size: 1.2rem;">Aucune s√©ance programm√©e</p>';
                    return;
                }

                // Grouper par date
                const seancesByDate = {};
                seances.forEach(s => {
                    const date = s.horaire.split(' ')[0];
                    if (!seancesByDate[date]) {
                        seancesByDate[date] = [];
                    }
                    seancesByDate[date].push(s);
                });

                let html = '';
                
                Object.keys(seancesByDate).sort().forEach(date => {
                    html += `<h2 class="date-header">üìÖ ${formatDate(date)}</h2>`;
                    
                    seancesByDate[date].forEach(seance => {
                        const time = seance.horaire.split(' ')[1];
                        const posterUrl = seance.poster_url || 'https://via.placeholder.com/100x150/141414/e50914?text=Film';
                        const remaining = seance.remaining || 0;
                        
                        html += `
                            <div class="seance-card">
                                <img src="${posterUrl}" alt="${seance.film}" class="seance-poster">
                                <div class="seance-info">
                                    <h3 class="seance-title">${seance.film}</h3>
                                    <div class="seance-meta">
                                        <span>üïê <strong>${time}</strong></span>
                                        <span>üö™ <strong>Salle ${seance.salle}</strong></span>
                                        <span style="color: ${remaining > 0 ? '#86efac' : '#fca5a5'}">
                                            üé´ <strong>${remaining > 0 ? remaining + ' places disponibles' : 'COMPLET'}</strong>
                                        </span>
                                    </div>
                                </div>
                                <div class="seance-actions">
                                    <span class="badge badge-salle">Salle ${seance.salle}</span>
                                    ${remaining > 0 ? 
                                        `<button onclick="reserverSeance(${seance.id}, '${seance.film}', '${time}')" class="btn btn-primary">R√©server</button>` 
                                        : 
                                        `<button disabled class="btn" style="background: #666; cursor: not-allowed;">Complet</button>`
                                    }
                                </div>
                            </div>
                        `;
                    });
                });
                
                seancesList.innerHTML = html;
            } catch (error) {
                loadingSpinner.style.display = 'none';
                console.error('Erreur:', error);
                seancesList.innerHTML = '<div class="alert alert-error">Erreur lors du chargement des s√©ances</div>';
            }
        }

        let currentReservation = null;
        let selectedSeats = 1;

        // Ouvre le modal de r√©servation avec les informations de la s√©ance
        function openModal(seanceId, filmTitle, time, remaining) {
            currentReservation = { seanceId, filmTitle, time, remaining };
            selectedSeats = 1;
            
            const modal = document.getElementById('reservationModal');
            const modalContent = document.getElementById('modalContent');
            const seatsButtons = document.getElementById('seatsButtons');
            const modalMessage = document.getElementById('modalMessage');
            
            modalContent.innerHTML = `
                <div style="color: var(--cinema-text); margin-bottom: 1rem;">
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;"><strong>${filmTitle}</strong></p>
                    <p style="color: var(--cinema-text-dim);">üïê ${time}</p>
                    <p style="color: var(--cinema-gold); margin-top: 0.5rem;">üìç ${remaining} places restantes</p>
                </div>
            `;
            
            // Cr√©er les boutons de s√©lection (1-5 ou moins si pas assez de places)
            const maxSeats = Math.min(5, remaining);
            seatsButtons.innerHTML = '';
            for (let i = 1; i <= maxSeats; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'btn';
                btn.style.cssText = 'min-width: 50px; background: #444;';
                btn.onclick = () => selectSeats(i, maxSeats);
                if (i === 1) {
                    btn.style.background = 'var(--cinema-accent)';
                }
                seatsButtons.appendChild(btn);
            }
            
            modalMessage.style.display = 'none';
            modal.style.display = 'flex';
        }

        // Met √† jour le nombre de places s√©lectionn√©es et met en surbrillance le bouton correspondant
        function selectSeats(num, max) {
            selectedSeats = num;
            const buttons = document.querySelectorAll('#seatsButtons button');
            buttons.forEach((btn, idx) => {
                if (idx + 1 === num) {
                    btn.style.background = 'var(--cinema-accent)';
                } else {
                    btn.style.background = '#444';
                }
            });
        }

        // Ferme le modal de r√©servation et r√©initialise les donn√©es
        function closeModal() {
            document.getElementById('reservationModal').style.display = 'none';
            currentReservation = null;
        }

        // Envoie la requ√™te de r√©servation au serveur et affiche le r√©sultat
        async function confirmReservation() {
            if (!currentReservation) return;
            
            const { seanceId, filmTitle, time } = currentReservation;
            const modalMessage = document.getElementById('modalMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'R√©servation...';

            try {
                const response = await fetch('/reserve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ seance_id: seanceId, seats: selectedSeats })
                });

                const data = await response.json();

                if (response.ok) {
                    modalMessage.style.display = 'block';
                    modalMessage.style.background = '#10b981';
                    modalMessage.style.color = 'white';
                    modalMessage.innerHTML = `‚úÖ ${data.message}<br><small>Rendez-vous dans 'Mes R√©servations'</small>`;
                    
                    setTimeout(() => {
                        closeModal();
                        loadSeances();
                    }, 2000);
                } else {
                    modalMessage.style.display = 'block';
                    modalMessage.style.background = '#ef4444';
                    modalMessage.style.color = 'white';
                    modalMessage.textContent = data.message;
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirmer';
                }
            } catch (error) {
                console.error('Erreur:', error);
                modalMessage.style.display = 'block';
                modalMessage.style.background = '#ef4444';
                modalMessage.style.color = 'white';
                modalMessage.textContent = 'Une erreur est survenue. Veuillez r√©essayer.';
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirmer';
            }
        }

        // R√©cup√®re les informations de la s√©ance et ouvre le modal de r√©servation
        async function reserverSeance(seanceId, filmTitle, time) {
            // R√©cup√©rer le nombre de places restantes pour cette s√©ance
            const response = await fetch('/api/seances');
            const seances = await response.json();
            const seance = seances.find(s => s.id === seanceId);
            const remaining = seance ? seance.remaining : 0;
            
            if (remaining === 0) {
                return;
            }
            
            openModal(seanceId, filmTitle, time, remaining);
        }

        // Formate une date au format fran√ßais (ex: lundi 5 d√©cembre 2025)
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('fr-FR', options);
        }

        const logoutLink = document.getElementById('logoutLink');
        if (logoutLink) {
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch('/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    if (res.ok) {
                        window.location.href = '/';
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }
    </script>
</body>
</html>